<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Data Job Observatory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- D3 + TopoJSON -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <style>
      :root {
        --bg-main: #0a0a0a;
        --bg-secondary: #111111;
        --panel: #0f172a;
        --card-bg: #161616;
        --text: #e0e0e0;
        --gray: #888888;
        --muted: #9ca3af;
        --accent: #00ffff;
        --accent-soft: rgba(0, 255, 255, 0.15);
        --accent-2: #a855f7;
        --border: #333;
        --danger: #f97373;
        --success: #22c55e;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827 0, #020617 55%);
        color: var(--text);
        line-height: 1.6;
        cursor: none;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      /* NAVBAR */
      nav {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 5%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 1000;
      }

      .logo {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--accent);
        text-decoration: none;
      }
      .logo span {
        color: white;
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: 2rem;
        align-items: center;
      }
      nav ul li {
        position: relative;
      }
      nav ul li a {
        color: var(--text);
        text-decoration: none;
        transition: 0.3s;
      }
      nav ul li a:hover {
        color: var(--accent);
      }
      nav ul li a.active {
        color: #ff69b4;
        text-shadow: 0 0 8px rgba(255, 105, 180, 0.6);
      }

      .dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: #111;
        border-radius: 6px;
        min-width: 160px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .dropdown-content li {
        display: block;
        padding: 0.5rem 1rem;
      }
      .dropdown-content li a {
        color: var(--gray);
      }
      .dropdown:hover .dropdown-content {
        display: block;
      }

      .guide-download {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border: 1px solid var(--accent, #00ffff);
  border-radius: 999px;
  color: var(--accent, #00ffff);
  font-size: 0.75rem;
  font-weight: 600;
  text-decoration: none;
  background: rgba(0, 0, 0, 0.6);
  transition: all 0.25s ease;
  white-space: nowrap;
}

.guide-download:hover {
  background: var(--accent, #00ffff);
  color: #000;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
}

      /* BACK TO TOP */
      #backToTop {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: var(--accent);
        color: #0a0a0a;
        border: none;
        border-radius: 50%;
        width: 55px;
        height: 55px;
        font-size: 1.6rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        display: none;
        z-index: 1000;
        transition: all 0.3s ease;
      }
      #backToTop:hover {
        background: #00ffff;
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.7);
        transform: scale(1.15);
      }

      /* CURSEUR PERSO */
      .cursor {
        width: 25px;
        height: 25px;
        border: 2px solid var(--accent);
        border-radius: 50%;
        position: fixed;
        left: 0;
        top: 0;
        transform: translate(-50%, -50%);
        transition: transform 0.08s ease;
        z-index: 9999;
        pointer-events: none;
      }

      /* CONTAINER PRINCIPAL */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 6rem 20px 40px; /* 6rem pour la nav */
      }

      /* HERO */
      .hero-banner-simple {
        padding: 2rem 0 2rem 0;
        text-align: left;
      }
      .hero-banner-simple h1 {
        font-size: 2.6rem;
        color: var(--accent);
        margin-bottom: 0.5rem;
      }
      .hero-banner-simple .subtitle {
        font-size: 1.1rem;
        color: var(--muted);
        max-width: 700px;
      }

      /* KPIs */
      .kpi-row {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 16px;
      }
      .kpi-card {
        background: rgba(10, 10, 10, 0.9);
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 14px 16px;
      }
      .kpi-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .kpi-main {
        font-size: 1.3rem;
        font-weight: 600;
      }
      .kpi-delta {
        font-size: 0.8rem;
        margin-left: 4px;
      }
      .kpi-delta.positive {
        color: var(--success);
      }
      .kpi-delta.negative {
        color: var(--danger);
      }

      @media (max-width: 900px) {
        .kpi-row {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      /* LAYOUT PRINCIPAL : sidebar filtres + graphs */
      .observatory-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
        align-items: start;
        margin-top: 2rem;
      }
      @media (max-width: 900px) {
        .observatory-layout {
          grid-template-columns: 1fr;
        }
      }

      /* SIDEBAR FILTRES */
      .filter-panel {
        background: var(--bg-secondary);
        padding: 18px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        position: sticky;
        top: 90px;
        max-height: calc(100vh - 110px);
        overflow-y: auto;
      }
      .filter-panel h2 {
        color: var(--accent);
        margin-bottom: 12px;
        font-size: 1.4rem;
      }
      .filter-panel small {
        color: var(--muted);
        display: block;
        margin-bottom: 16px;
        font-size: 0.8rem;
      }

      .filter-group {
        margin-bottom: 18px;
      }
      .filter-group label.main-label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--text);
        font-size: 0.9rem;
      }
      .filter-group .helper {
        font-size: 0.75rem;
        color: var(--muted);
        margin-bottom: 4px;
      }

      input[type="text"],
      select {
        width: 100%;
        padding: 8px 10px;
        background: #222;
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 999px;
        font-size: 0.9rem;
      }
      input[type="text"]:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
      }

      .salary-slider-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      input[type="range"] {
        flex-grow: 1;
        cursor: pointer;
      }
      #salary-value {
        font-weight: bold;
        color: var(--accent);
        min-width: 60px;
        text-align: right;
        font-size: 0.85rem;
      }

      .toggle-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .toggle-chip {
        flex: 1 1 48%;
        display: flex;
        align-items: center;
        gap: 6px;
        background: #1b1b1b;
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 4px 10px;
        font-size: 0.8rem;
      }
      .toggle-chip input {
        accent-color: var(--accent);
        cursor: pointer;
      }

      .filter-list {
        max-height: 150px;
        overflow-y: auto;
        background: #141414;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
        font-size: 0.85rem;
      }
      .filter-item {
        margin-bottom: 6px;
      }
      .filter-item label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: var(--muted);
      }
      .filter-item input[type="checkbox"] {
        accent-color: var(--accent);
        cursor: pointer;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        font-size: 0.78rem;
        padding: 4px 9px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #1b1b1b;
        cursor: pointer;
        user-select: none;
        color: var(--muted);
      }
      .chip.active {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: var(--accent);
      }

      #reset-filters {
        width: 100%;
        padding: 10px;
        background: #222;
        color: var(--text);
        border: none;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 4px;
        transition: background 0.3s;
      }
      #reset-filters:hover {
        background: #333;
      }

      /* ZONE GRAPHIQUES */
      .results-area-header {
        margin-bottom: 10px;
      }
      .results-area-header h2 {
        font-size: 1.5rem;
        margin-bottom: 4px;
      }
      .results-area-header p {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .charts-grid {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .chart-card {
        background: rgba(10, 10, 10, 0.96);
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 14px 14px 10px;
        min-height: 260px;
        display: flex;
        flex-direction: column;
        position: relative;
        cursor: zoom-in;
        transition: box-shadow 0.2s, border-color 0.2s, transform 0.2s;
      }
      .chart-card:hover {
        border-color: var(--accent);
        box-shadow: 0 0 18px rgba(0, 255, 255, 0.18);
        transform: translateY(-2px);
      }
      .chart-card h3 {
        font-size: 1rem;
        margin-bottom: 2px;
      }
      .chart-subtitle {
        font-size: 0.8rem;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .chart-inner {
        position: relative;
        width: 100%;
        flex: 1;
        min-height: 210px;
      }
      .chart-svg {
        width: 100%;
        height: 100%;
        overflow: visible;
      }
      .chart-tooltip {
        position: absolute;
        pointer-events: none;
        background: rgba(15, 23, 42, 0.98);
        color: var(--text);
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 6px 8px;
        font-size: 0.75rem;
        z-index: 10;
        opacity: 0;
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }
      .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: var(--muted);
      }
      .legend-swatch {
        width: 10px;
        height: 10px;
        border-radius: 3px;
      }

      .axis path,
      .axis line {
        stroke: rgba(148, 163, 184, 0.3);
      }
      .axis text {
        fill: var(--muted);
        font-size: 10px;
      }

      .quadrant-label {
        font-size: 0.7rem;
        fill: var(--muted);
      }

      .hidden {
        display: none !important;
      }

      /* MODALE GRAPHIQUE */
      #chart-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(6px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #chart-modal-content {
        background: #111;
        border-radius: 10px;
        border: 1px solid var(--accent);
        width: 90vw;
        max-width: 1100px;
        max-height: 90vh;
        padding: 16px 18px 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      }
      #chart-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      #chart-modal-title {
        font-size: 1rem;
        font-weight: 600;
      }
      #chart-modal-close {
        font-size: 1.8rem;
        background: none;
        border: none;
        color: var(--gray);
        cursor: pointer;
        line-height: 1;
      }
      #chart-modal-close:hover {
        color: var(--accent);
      }
      #chart-modal-body {
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
      }
      #chart-modal-container {
        flex: 1;
        min-height: 380px;
      }
      #chart-modal-container svg {
        width: 100% !important;
        height: auto !important;
      }
      #chart-modal-description {
        font-size: 0.83rem;
        color: var(--muted);
        margin-top: 8px;
      }
      .cta-row {
        margin-top: 40px;
        display: flex;
        gap: 20px;
        justify-content: center;
      }

      .cta-button {
        background: #d81d8a;
        padding: 12px 22px;
        border-radius: 999px;
        color: white;
        border: none;
        font-size: 1rem;
        cursor: pointer;
      }
      .cta-button:hover {
        background: #25e8eb;
      }

      /* FOOTER */
      footer {
        text-align: center;
        padding: 2rem;
        font-size: 0.9rem;
        color: var(--gray);
        border-top: 1px solid #222;
        margin-top: 2rem;
      }
    </style>
  </head>

  <body>
    <div class="cursor"></div>

    <nav>
      <a href="/startup" class="logo">Data<span>Universe</span></a>

      <ul class="menu">
        <li><a href="/" class="active">The Observatory</a></li>

        <li class="dropdown">
          <a href="/startup#project" class="dropdown-toggle">Project ▾</a>
          <ul class="dropdown-content">
            <li><a href="/explanation">Explanation</a></li>
            <li><a href="/startup#objective">Objective</a></li>
            <li><a href="/startup#motivation">Motivation</a></li>
            <li><a href="/startup#tasks">Main Tasks</a></li>
            <li><hr class="dropdown-divider" /></li>
            <li class="dropdown-header">Results</li>
            <li><a href="/startup#expected">Expected Results</a></li>
          </ul>
        </li>

        <li><a href="/index">The Big Picture</a></li>
        <li><a href="/explorateur">The Job Explorer</a></li>
        <li><a href="/tendances">The Hidden Trends</a></li>
        <li><a href="/startup#contact">Contact</a></li>
      </ul>
      <a href="/static/DataUniverse_Guide.pdf" class="guide-download" target="_blank">
  ⓘ Project Guide
</a>

    </nav>

    <button id="backToTop">↑</button>

    <div class="container">
      <!-- HERO + KPIs -->
      <header class="hero-banner-simple">
        <h1>The Data Job Observatory</h1>
        <p class="subtitle">
          Follow how the data job market moves over time: roles, technologies,
          soft skills, domains and how closely your profile matches the current
          wave.
        </p>

        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">Total job offers (last 30 days)</div>
            <div>
              <span class="kpi-main" id="kpi-total-jobs">–</span>
              <span class="kpi-delta" id="kpi-total-jobs-delta">…</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Hottest role</div>
            <div class="kpi-main" id="kpi-hottest-role">–</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Tech in the spotlight</div>
            <div class="kpi-main" id="kpi-hottest-tech">–</div>
          </div>
        </div>
      </header>

      <main class="observatory-layout">
        <!-- FILTERS SIDEBAR -->
        <aside class="filter-panel">
          <h2>Filters</h2>
          <small
            >These filters drive all charts on the right. You can mix text,
            skills, salary and country to see how the market reacts.</small
          >

          <div class="filter-group">
            <label class="main-label" for="filter-text"
              >Search (title / description)</label
            >
            <input
              type="text"
              id="filter-text"
              placeholder="e.g. Data Analyst, Python, SQL..."
            />
          </div>

          <div class="filter-group">
            <label class="main-label"
              >Min salary (annual): <span id="salary-value">$0k</span></label
            >
            <div class="salary-slider-container">
              <span style="font-size: 0.8rem">$0</span>
              <input
                type="range"
                id="filter-salary"
                min="0"
                max="300000"
                step="10000"
                value="0"
              />
              <span style="font-size: 0.8rem">$300k+</span>
            </div>
          </div>

          <div class="filter-group">
            <label class="main-label" for="filter-date-range"
              >Time window</label
            >
            <select id="filter-date-range">
              <option value="all">All available</option>
              <option value="30">Last 30 days</option>
              <option value="60">Last 60 days</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="main-label">Job conditions</label>
            <div class="toggle-row">
              <div class="toggle-chip">
                <input type="checkbox" id="filter-hybrid" />
                <label for="filter-hybrid">Remote / Hybrid only</label>
              </div>
              <div class="toggle-chip">
                <input type="checkbox" id="filter-visa" />
                <label for="filter-visa">Visa sponsorship</label>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <label class="main-label">Countries</label>
            <p class="helper">Select one or more countries.</p>
            <div id="filter-country" class="filter-list"></div>
          </div>

          <div class="filter-group">
            <label class="main-label">Roles</label>
            <p class="helper">Based on a normalized role classification.</p>
            <div id="filter-role" class="filter-list"></div>
          </div>

          <div class="filter-group">
            <label class="main-label">Core technical skills (AND)</label>
            <p class="helper">
              Click skills to select them. Jobs must contain all selected
              skills.
            </p>
            <div id="filter-skills-chips" class="chip-row"></div>
          </div>

          <button id="reset-filters">Reset all filters</button>
        </aside>

        <!-- CHARTS AREA -->
        <section>
          <div class="results-area-header">
            <h2>Live overview of your data job market</h2>
            <p>
              All charts below are computed directly from your scraped offers
              and will update as you add new months and new scrapes.
            </p>
          </div>

          <div class="charts-grid">
            <!-- 1. JOB VOLUME OVER TIME -->
            <article class="chart-card" data-chart="job-volume">
              <h3>Job volume over time</h3>
              <p class="chart-subtitle">
                Monthly number of offers in the dataset (baseline) compared to
                the currently filtered subset.
              </p>
              <div class="chart-inner" id="job-volume-container">
                <svg class="chart-svg" id="job-volume-svg"></svg>
              </div>
            </article>

            <!-- 2. ROLE DRIFT -->
            <article class="chart-card" data-chart="role-drift">
              <h3>Role Drift — how skill sets evolve</h3>
              <p class="chart-subtitle">
                For a given role, track how often key technical skills appear
                month after month.
              </p>
              <div class="chart-inner" id="role-drift-container">
                <svg class="chart-svg" id="role-drift-svg"></svg>
                <div class="chart-tooltip" id="role-drift-tooltip"></div>
              </div>
              <div class="legend" id="role-drift-legend"></div>
              <div
                style="margin-top: 4px; font-size: 0.8rem; color: var(--muted)"
              >
                Role:
                <select
                  id="role-select"
                  style="
                    display: inline-block;
                    width: auto;
                    padding: 4px 8px;
                    margin-left: 4px;
                    font-size: 0.8rem;
                  "
                ></select>
              </div>
            </article>

            <!-- 3. SOFT SKILLS DRIFT -->
            <article class="chart-card" data-chart="soft-drift">
              <h3>Soft skills dynamics</h3>
              <p class="chart-subtitle">
                Evolution of the most frequently mentioned soft skills in the
                current filters over recent months.
              </p>
              <div class="chart-inner" id="soft-drift-container">
                <svg class="chart-svg" id="soft-drift-svg"></svg>
                <div class="chart-tooltip" id="soft-drift-tooltip"></div>
              </div>
              <div class="legend" id="soft-drift-legend"></div>
            </article>

            <!-- 5. MY MARKET WORTH -->
            <article class="chart-card" data-chart="mmw">
              <h3>My Market Worth — inside this dataset</h3>
              <p class="chart-subtitle">
                Based on your selected skills and years of experience, estimate
                how many offers match you and their salary distribution.
              </p>
              <div style="font-size: 0.8rem; margin-bottom: 4px">
                <label for="mmw-experience">Years of experience</label>
                <select
                  id="mmw-experience"
                  style="
                    display: inline-block;
                    width: auto;
                    padding: 4px 8px;
                    margin-left: 6px;
                    font-size: 0.8rem;
                  "
                >
                  <option value="0">0–1 years</option>
                  <option value="2">2–4 years</option>
                  <option value="5">5+ years</option>
                </select>
              </div>
              <div
                id="mmw-skill-chips"
                class="chip-row"
                style="margin-bottom: 6px"
              ></div>
              <div class="chart-inner" id="mmw-container">
                <svg class="chart-svg" id="mmw-svg"></svg>
                <div class="chart-tooltip" id="mmw-tooltip"></div>
              </div>
              <div
                id="mmw-output"
                style="font-size: 0.8rem; color: var(--muted); margin-top: 4px"
              >
                Select some skills to see your estimated worth inside this
                dataset.
              </div>
              <div
                id="mmw-extra"
                style="font-size: 0.76rem; color: var(--muted); margin-top: 4px"
              ></div>
            </article>

            <!-- 6. WORLD MAP -->
            <article class="chart-card" data-chart="worldmap">
              <h3>Geographical distribution of offers</h3>
              <p class="chart-subtitle">
                Each circle represents how many job offers are associated with a
                country in the current filters.
              </p>
              <div class="chart-inner" id="worldmap-container">
                <svg class="chart-svg" id="worldmap-svg"></svg>
                <div class="chart-tooltip" id="worldmap-tooltip"></div>
              </div>
            </article>
            <div class="cta-row">
              <button
                class="cta-button"
                onclick="window.location.href='/explorateur'"
              >
                Explore job explorer
              </button>

              <button
                class="cta-button"
                onclick="window.location.href='/index'"
              >
                Explore data landscape
              </button>
            </div>
          </div>
        </section>
      </main>

      <footer>
        DataUniverse – Data Job Observatory © 2025 – Developed by Safia Lamri
      </footer>
    </div>

    <!-- MODALE POUR AGRANDIR LES GRAPHIQUES -->
    <div id="chart-modal-backdrop" class="hidden">
      <div id="chart-modal-content">
        <div id="chart-modal-header">
          <span id="chart-modal-title"></span>
          <button id="chart-modal-close">&times;</button>
        </div>
        <div id="chart-modal-body">
          <div id="chart-modal-container"></div>
          <div id="chart-modal-description"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /* 0. CUSTOM CURSOR + BACK TO TOP*/
        const cursor = document.querySelector(".cursor");
        if (cursor) {
          document.addEventListener("mousemove", (e) => {
            cursor.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
          });
        }

        const backToTop = document.getElementById("backToTop");
        if (backToTop) {
          window.addEventListener("scroll", () => {
            backToTop.style.display = window.scrollY > 400 ? "block" : "none";
          });

          backToTop.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        }

        /* 1. CONFIG & DATA*/
        const DATA_FILE = "/api/data";

        const TRACKED_TECH = [
          "sql",
          "python",
          "r",
          "excel",
          "tableau",
          "power bi",
          "powerbi",
          "looker",
          "looker studio",
          "snowflake",
          "bigquery",
          "redshift",
          "spark",
          "hadoop",
          "airflow",
          "dbt",
          "aws",
          "gcp",
          "azure",
          "saas",
          "llm",
          "generative ai",
          "machine learning",
        ];

        const MMW_SKILLS = [
          "sql",
          "python",
          "tableau",
          "power bi",
          "excel",
          "aws",
          "gcp",
          "snowflake",
          "dbt",
          "airflow",
        ];

        const parseDate = d3.timeParse("%Y-%m-%d");
        const parseDateAlt = d3.timeParse("%Y-%m-%dT%H:%M:%SZ");

        let allJobs = [];
        let filteredJobs = [];

        // World map cache
        let worldGeo = null;
        let worldGeoPromise = null;

        /*  2. HELPERS
/* ROLE CLASSIFIER */
        function classifyRole(titleRaw) {
          if (!titleRaw) return "Other data role";
          const t = titleRaw.toLowerCase();
          if (t.includes("analytics engineer")) return "Analytics Engineer";
          if (t.includes("engineer")) return "Data Engineer";
          if (t.includes("scientist")) return "Data Scientist";
          if (t.includes("analytics") || t.includes("analyst"))
            return "Data Analyst";
          if (t.includes("business intelligence") || t.includes("bi "))
            return "BI / Analytics";
          if (t.includes("machine learning") || t.includes("ml "))
            return "ML Engineer";
          return "Other data role";
        }

        /*SKILL PARSER  */
        function parseSkillList(value) {
          if (!value) return [];

          // Case 1 : value is already an array
          if (Array.isArray(value)) {
            return value
              .map((v) => String(v).trim().toLowerCase())
              .filter(Boolean);
          }

          // Case 2 : fallback for string input
          return String(value)
            .split(/;|,|\|/)
            .map((t) => t.trim().toLowerCase())
            .filter(Boolean);
        }

        /* ROW PARSER */
        function rowParser(d) {
          let date = null;
          if (d.date_posted) {
            date = parseDate(d.date_posted) || parseDateAlt(d.date_posted);
            if (!date && !isNaN(Date.parse(d.date_posted))) {
              date = new Date(d.date_posted);
            }
          }

          // Accepts strings OR arrays
          const techSkills = parseSkillList(d.technical_skills);
          const toolsUsed = parseSkillList(d.tools_used);
          const softSkills = parseSkillList(d.soft_skills);
          const domains = parseSkillList(d.domains);

          // Salary
          let salary = d.salary_value ? +d.salary_value : NaN;
          if (!isFinite(salary)) salary = NaN;

          // Experience
          let expYears = d.experience_years ? +d.experience_years : NaN;
          if (!isFinite(expYears)) expYears = NaN;

          // hybrid_policy is boolean, not string
          const hybrid =
            d.hybrid_policy === true ||
            String(d.hybrid_policy ?? "").toLowerCase() === "true" ||
            String(d.hybrid_policy ?? "").toLowerCase() === "hybrid" ||
            String(d.hybrid_policy ?? "").toLowerCase() === "remote";

          //  visa_sponsorship is boolean
          const visa =
            d.visa_sponsorship === true ||
            d.visa_sponsorship === "True" ||
            d.visa_sponsorship === "true" ||
            String(d.visa_sponsorship ?? "").toLowerCase() === "yes" ||
            String(d.visa_sponsorship ?? "").toLowerCase() === "true";

          return {
            ...d,
            _date: date,
            _month: date ? d3.timeMonth(date) : null,
            _role: classifyRole(d.title || d.job_title),

            // normalized lists
            _techSkills: techSkills,
            _toolsUsed: toolsUsed,
            _softSkills: softSkills,
            _domains: domains,

            // correct booleans
            _hybrid: hybrid,
            _visa: visa,

            _country: d.country || "Not specified",
            _salary: salary,
            _exp: expYears,
          };
        }
        function getUniqueValues(data, accessor) {
          const set = new Set();
          data.forEach((d) => {
            const v = accessor(d);
            if (Array.isArray(v)) {
              v.forEach((x) => x && set.add(x));
            } else if (v) {
              set.add(v);
            }
          });
          return Array.from(set).sort();
        }

        function getCheckedValues(container) {
          if (!container) return [];
          const checkedInputs = container.querySelectorAll(
            'input[type="checkbox"]:checked'
          );
          return Array.from(checkedInputs).map((input) => input.value);
        }

        /* 3. DOM SELECTORS */
        const filterInputs = {
          text: document.getElementById("filter-text"),
          salary: document.getElementById("filter-salary"),
          dateRange: document.getElementById("filter-date-range"),
          hybrid: document.getElementById("filter-hybrid"),
          visa: document.getElementById("filter-visa"),
        };
        const salaryValueLabel = document.getElementById("salary-value");

        const filterGroups = {
          country: document.getElementById("filter-country"),
          role: document.getElementById("filter-role"),
          seniority: document.getElementById("filter-seniority"),
          skillsChips: document.getElementById("filter-skills-chips"),
        };

        const resetFiltersBtn = document.getElementById("reset-filters");

        const roleSelect = document.getElementById("role-select");

        // Modal
        const modalBackdrop = document.getElementById("chart-modal-backdrop");
        const modalTitle = document.getElementById("chart-modal-title");
        const modalContainer = document.getElementById("chart-modal-container");
        const modalDescription = document.getElementById(
          "chart-modal-description"
        );
        const modalCloseBtn = document.getElementById("chart-modal-close");

        /* 4. DATA LOADING */
        fetch(DATA_FILE)
          .then((res) => res.json())
          .then((raw) => {
            const dataRaw = raw.map(rowParser);
            allJobs = dataRaw.filter((d) => d._date);
            console.log("Observatory data loaded:", allJobs.length);

            initFilters(allJobs);
            initMyMarketWorthModule();
            applyFilters();
            setupChartModal();
          })
          .catch((err) => {
            console.error("Error loading data:", err);
          });

        /* 5. FILTERS */
        let selectedSkillChips = new Set();

        function initFilters(data) {
          if (salaryValueLabel && filterInputs.salary) {
            salaryValueLabel.textContent = "$0k";
            filterInputs.salary.value = 0;
          }

          createCheckboxList(
            filterGroups.country,
            getUniqueValues(data, (d) => d._country)
          );
          createCheckboxList(
            filterGroups.role,
            getUniqueValues(data, (d) => d._role)
          );
          createCheckboxList(
            filterGroups.seniority,
            getUniqueValues(data, (d) => d.seniority_level || "Not specified")
          );

          initSkillChips(data);
          initRoleSelects(data);
          setupFilterListeners();
        }

        function createCheckboxList(container, values) {
          if (!container) return;
          container.innerHTML = "";
          if (!values.length) {
            container.innerHTML =
              '<em style="color:var(--muted); font-size:0.8rem;">No data</em>';
            return;
          }
          values.forEach((val) => {
            const item = document.createElement("div");
            item.className = "filter-item";
            const escaped = val.replace(/"/g, "&quot;");
            item.innerHTML = `
        <label>
          <input type="checkbox" value="${escaped}">
          <span>${val}</span>
        </label>
      `;
            container.appendChild(item);
          });
        }

        function initSkillChips(data) {
          const container = filterGroups.skillsChips;
          if (!container) return;
          container.innerHTML = "";
          selectedSkillChips.clear();

          const counts = new Map();
          data.forEach((d) => {
            d._techSkills.forEach((s) => {
              counts.set(s, (counts.get(s) || 0) + 1);
            });
          });

          const sorted = Array.from(counts.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 18)
            .map(([skill]) => skill);

          sorted.forEach((skill) => {
            const div = document.createElement("div");
            div.className = "chip";
            div.textContent = skill;
            div.dataset.skill = skill;
            div.addEventListener("click", () => {
              if (selectedSkillChips.has(skill)) {
                selectedSkillChips.delete(skill);
                div.classList.remove("active");
              } else {
                selectedSkillChips.add(skill);
                div.classList.add("active");
              }
              applyFilters();
            });
            container.appendChild(div);
          });
        }

        function initRoleSelects(data) {
          if (!roleSelect) return;
          const roles = Array.from(
            new Set(data.map((d) => d._role).filter(Boolean))
          ).sort();

          roleSelect.innerHTML = "";
          roles.forEach((r) => {
            const opt = document.createElement("option");
            opt.value = r;
            opt.textContent = r;
            roleSelect.appendChild(opt);
          });

          const defaultRole =
            roles.find((r) => r.includes("Analyst")) ||
            roles.find((r) => r.includes("Engineer")) ||
            roles[0];
          if (defaultRole) roleSelect.value = defaultRole;
        }

        function setupFilterListeners() {
          Object.values(filterInputs).forEach((el) => {
            if (!el) return;
            const evt = el === filterInputs.text ? "input" : "change";
            el.addEventListener(evt, applyFilters);
          });

          if (filterInputs.salary && salaryValueLabel) {
            filterInputs.salary.addEventListener("input", (e) => {
              const valK = (e.target.value / 1000).toFixed(0);
              salaryValueLabel.textContent = `$${valK}k`;
            });
            filterInputs.salary.addEventListener("change", applyFilters);
          }

          [
            filterGroups.country,
            filterGroups.role,
            filterGroups.seniority,
          ].forEach((group) => {
            if (!group) return;
            group.addEventListener("change", applyFilters);
          });

          if (roleSelect) {
            roleSelect.addEventListener("change", () => {
              updateRoleDriftChart();
            });
          }

          if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener("click", () => {
              if (filterInputs.text) filterInputs.text.value = "";
              if (filterInputs.salary) {
                filterInputs.salary.value = 0;
                if (salaryValueLabel) salaryValueLabel.textContent = "$0k";
              }
              if (filterInputs.dateRange) filterInputs.dateRange.value = "all";
              if (filterInputs.hybrid) filterInputs.hybrid.checked = false;
              if (filterInputs.visa) filterInputs.visa.checked = false;

              [
                filterGroups.country,
                filterGroups.role,
                filterGroups.seniority,
              ].forEach((group) => {
                if (!group) return;
                group
                  .querySelectorAll('input[type="checkbox"]')
                  .forEach((cb) => (cb.checked = false));
              });

              selectedSkillChips.clear();
              if (filterGroups.skillsChips) {
                filterGroups.skillsChips
                  .querySelectorAll(".chip")
                  .forEach((chip) => chip.classList.remove("active"));
              }

              applyFilters();
            });
          }
        }

        function applyFilters() {
          const text = filterInputs.text?.value.toLowerCase().trim() || "";
          const minSalary = filterInputs.salary
            ? +filterInputs.salary.value || 0
            : 0;
          const dateRange = filterInputs.dateRange?.value || "all";
          const onlyHybrid = !!filterInputs.hybrid?.checked;
          const onlyVisa = !!filterInputs.visa?.checked;

          const selectedCountries = getCheckedValues(filterGroups.country);
          const selectedRoles = getCheckedValues(filterGroups.role);
          const selectedSeniorities = getCheckedValues(filterGroups.seniority);
          const selectedSkills = Array.from(selectedSkillChips);

          const now = d3.max(allJobs, (d) => d._date);
          let minDateFilter = null;
          if (now && dateRange === "30") {
            minDateFilter = d3.timeDay.offset(now, -30);
          } else if (now && dateRange === "60") {
            minDateFilter = d3.timeDay.offset(now, -60);
          }

          filteredJobs = allJobs.filter((job) => {
            if (minDateFilter && job._date && job._date < minDateFilter) {
              return false;
            }

            if (text) {
              const t =
                (job.title || "").toLowerCase() +
                " " +
                (
                  job.description_sans_html ||
                  job.description ||
                  ""
                ).toLowerCase();
              if (!t.includes(text)) return false;
            }

            if (minSalary > 0) {
              if (!job._salary || job._salary < minSalary) return false;
            }

            if (onlyHybrid && !job._hybrid) return false;

            if (onlyVisa && !job._visa) return false;

            if (
              selectedCountries.length &&
              !selectedCountries.includes(job._country)
            )
              return false;

            if (selectedRoles.length && !selectedRoles.includes(job._role))
              return false;

            const sLevel = job.seniority_level || "Not specified";
            if (
              selectedSeniorities.length &&
              !selectedSeniorities.includes(sLevel)
            )
              return false;

            if (selectedSkills.length) {
              const skillSet = new Set(job._techSkills);
              const ok = selectedSkills.every((s) => skillSet.has(s));
              if (!ok) return false;
            }

            return true;
          });

          computeGlobalKPIs();
          updateJobVolumeChart();
          updateRoleDriftChart();
          updateSoftSkillDriftChart();
          updateMyMarketWorthChart();
          updateWorldMapChart();
        }

        /* 6. KPIs */
        function computeGlobalKPIs() {
          const data = filteredJobs.length ? filteredJobs : allJobs;
          if (!data.length) return;

          const now = d3.max(data, (d) => d._date);
          if (!now) return;

          const last30 = data.filter(
            (d) => now - d._date <= 30 * 24 * 3600 * 1000
          );
          const prev30 = data.filter(
            (d) =>
              now - d._date > 30 * 24 * 3600 * 1000 &&
              now - d._date <= 60 * 24 * 3600 * 1000
          );

          const totalLast = last30.length;
          const totalPrev = prev30.length || 1;
          const delta = ((totalLast - totalPrev) / totalPrev) * 100;

          const totalJobsEl = document.getElementById("kpi-total-jobs");
          const deltaEl = document.getElementById("kpi-total-jobs-delta");
          if (totalJobsEl) totalJobsEl.textContent = totalLast.toLocaleString();
          if (deltaEl) {
            const deltaRounded = Math.round(delta);
            deltaEl.textContent =
              (deltaRounded > 0 ? "+" : "") + deltaRounded + "% vs prev.";
            deltaEl.className =
              "kpi-delta " + (deltaRounded >= 0 ? "positive" : "negative");
          }

          const roleCounts = d3.rollup(
            last30,
            (v) => v.length,
            (d) => d._role
          );
          const bestRole = Array.from(roleCounts.entries()).sort(
            (a, b) => b[1] - a[1]
          )[0];
          const hottestRoleEl = document.getElementById("kpi-hottest-role");
          if (bestRole && hottestRoleEl) {
            hottestRoleEl.textContent = bestRole[0];
          }

          const countTech = (subset) =>
            d3.rollup(
              subset,
              (v) => v.length,
              (d) => {
                const skills = [...d._techSkills, ...d._toolsUsed];
                const set = new Set(skills);
                const found = TRACKED_TECH.filter((t) =>
                  Array.from(set).some((s) => s.includes(t))
                );
                return found.join("|") || null;
              }
            );

          const techLast = countTech(last30);
          const techPrev = countTech(prev30);

          let bestTechName = "";
          let bestTechScore = -Infinity;

          for (const [k, v] of techLast.entries()) {
            if (!k) continue;
            const prev = techPrev.get(k) || 1;
            const growth = (v - prev) / prev;
            if (growth > bestTechScore && v >= 3) {
              bestTechScore = growth;
              bestTechName = k.split("|")[0];
            }
          }
          const hottestTechEl = document.getElementById("kpi-hottest-tech");
          if (hottestTechEl) {
            hottestTechEl.textContent = bestTechName || "–";
          }
        }

        /* 7. JOB VOLUME OVER TIME */
        function aggregateJobsByMonth(dataSubset) {
          const monthMap = new Map();
          dataSubset.forEach((d) => {
            if (!d._date) return;
            const mKey = d3.timeMonth(d._date).getTime();
            if (!monthMap.has(mKey)) {
              monthMap.set(mKey, {
                month: new Date(mKey),
                count: 0,
              });
            }
            monthMap.get(mKey).count += 1;
          });
          return Array.from(monthMap.values()).sort(
            (a, b) => a.month - b.month
          );
        }

        function updateJobVolumeChart() {
          const container = document.getElementById("job-volume-container");
          const svg = d3.select("#job-volume-svg");
          if (!container || svg.empty()) return;

          svg.selectAll("*").remove();

          const dataAll = allJobs;
          if (!dataAll.length) return;

          const width = container.clientWidth || 600;
          const height = container.clientHeight || 260;
          const margin = { top: 10, right: 20, bottom: 28, left: 50 };

          svg.attr("viewBox", [0, 0, width, height]);

          const baseline = aggregateJobsByMonth(dataAll);
          const filtered = aggregateJobsByMonth(
            filteredJobs.length ? filteredJobs : dataAll
          );

          const allDates = baseline.map((d) => d.month);
          const xDomain =
            allDates.length > 0
              ? d3.extent(allDates)
              : [new Date(), new Date(new Date().getTime() + 86400000)];

          const x = d3
            .scaleTime()
            .domain(xDomain)
            .range([margin.left, width - margin.right]);

          const maxAll = d3.max(baseline, (d) => d.count) || 1;
          const maxFil = d3.max(filtered, (d) => d.count) || 1;
          const yMax = Math.max(maxAll, maxFil);

          const y = d3
            .scaleLinear()
            .domain([0, yMax])
            .nice()
            .range([height - margin.bottom, margin.top]);

          const xAxis = d3
            .axisBottom(x)
            .ticks(6)
            .tickFormat(d3.timeFormat("%b %Y"));
          const yAxis = d3.axisLeft(y).ticks(4);

          svg
            .append("g")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .attr("class", "axis")
            .call(xAxis);

          svg
            .append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .attr("class", "axis")
            .call(yAxis)
            .call((g) => g.select(".domain").remove());

          const line = d3
            .line()
            .x((d) => x(d.month))
            .y((d) => y(d.count))
            .curve(d3.curveMonotoneX);

          svg
            .append("path")
            .datum(baseline)
            .attr("fill", "none")
            .attr("stroke", "#4b5563")
            .attr("stroke-width", 2)
            .attr("d", line)
            .attr("opacity", 0.9);

          svg
            .append("path")
            .datum(filtered)
            .attr("fill", "none")
            .attr("stroke", "#22d3ee")
            .attr("stroke-width", 2.4)
            .attr("stroke-linecap", "round")
            .attr("stroke-linejoin", "round")
            .attr("d", line)
            .attr("opacity", 0.95);

          const legend = svg
            .append("g")
            .attr("transform", `translate(${width - 170},${margin.top + 4})`);

          const legendItems = [
            { label: "All jobs (baseline)", color: "#4b5563" },
            { label: "Filtered jobs", color: "#22d3ee" },
          ];

          legendItems.forEach((item, i) => {
            const row = legend
              .append("g")
              .attr("transform", `translate(0,${i * 16})`);

            row
              .append("rect")
              .attr("width", 10)
              .attr("height", 10)
              .attr("rx", 2)
              .attr("ry", 2)
              .attr("fill", item.color);

            row
              .append("text")
              .attr("x", 16)
              .attr("y", 9)
              .text(item.label)
              .attr("fill", "#9ca3af")
              .style("font-size", "10px");
          });
        }

        /* 8. ROLE DRIFT*/
        function updateRoleDriftChart() {
          const container = document.getElementById("role-drift-container");
          const svg = d3.select("#role-drift-svg");
          const tooltip = d3.select("#role-drift-tooltip");
          const legendDiv = d3.select("#role-drift-legend");

          if (!container || svg.empty()) return;

          svg.selectAll("*").remove();
          legendDiv.selectAll("*").remove();

          const data = filteredJobs.length ? filteredJobs : allJobs;
          if (!data.length) return;

          const width = container.clientWidth || 600;
          const height = container.clientHeight || 260;
          const margin = { top: 20, right: 10, bottom: 26, left: 50 };

          svg.attr("viewBox", [0, 0, width, height]);

          const role = roleSelect && roleSelect.value ? roleSelect.value : null;
          const roleData = data.filter((d) => d._role === role && d._month);

          if (!roleData.length) {
            svg
              .append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .attr("fill", "#6b7280")
              .text("No data for this role in the current filters.");
            return;
          }

          const months = Array.from(
            d3
              .rollup(
                roleData,
                (v) => v.length,
                (d) => +d._month
              )
              .keys()
          )
            .map((t) => new Date(t))
            .sort(d3.ascending);

          const maxMonths = 8;
          const selectedMonths =
            months.length > maxMonths ? months.slice(-maxMonths) : months;

          const records = [];
          const KEY_SKILLS = [
            "sql",
            "python",
            "tableau",
            "power bi",
            "powerbi",
            "excel",
            "snowflake",
            "dbt",
            "airflow",
            "spark",
            "aws",
            "gcp",
            "azure",
          ];

          roleData.forEach((job) => {
            const monthKey = +d3.timeMonth(job._date);
            if (!selectedMonths.some((m) => +m === monthKey)) return;

            const skillSet = new Set([...job._techSkills, ...job._toolsUsed]);
            KEY_SKILLS.forEach((skill) => {
              const matched = Array.from(skillSet).some((s) =>
                s.includes(skill)
              );
              if (matched) {
                records.push({
                  month: new Date(monthKey),
                  skill,
                });
              }
            });
          });

          if (!records.length) {
            svg
              .append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .attr("fill", "#6b7280")
              .text("No tracked skills found for this role.");
            return;
          }

          const aggregated = d3.rollups(
            records,
            (v) => v.length,
            (d) => d.skill,
            (d) => +d.month
          );

          const series = aggregated.map(([skill, entries]) => {
            const map = new Map(entries);
            return {
              skill,
              values: selectedMonths.map((m) => ({
                month: m,
                count: map.get(+m) || 0,
              })),
            };
          });

          const ranked = series
            .map((s) => ({
              ...s,
              total: d3.sum(s.values, (v) => v.count),
            }))
            .filter((s) => s.total > 0)
            .sort((a, b) => b.total - a.total)
            .slice(0, 6);

          if (!ranked.length) {
            svg
              .append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .attr("fill", "#6b7280")
              .text("Not enough signal to show evolution.");
            return;
          }

          const x = d3
            .scaleTime()
            .domain(d3.extent(selectedMonths))
            .range([margin.left, width - margin.right]);

          const maxCount = d3.max(ranked, (s) =>
            d3.max(s.values, (v) => v.count)
          );
          const y = d3
            .scaleLinear()
            .domain([0, maxCount || 1])
            .nice()
            .range([height - margin.bottom, margin.top + 10]);

          const color = d3
            .scaleOrdinal()
            .domain(ranked.map((d) => d.skill))
            .range([
              "#22d3ee",
              "#a855f7",
              "#f97316",
              "#4ade80",
              "#facc15",
              "#38bdf8",
            ]);

          const xAxis = d3
            .axisBottom(x)
            .ticks(selectedMonths.length)
            .tickFormat(d3.timeFormat("%b %y"));
          const yAxis = d3
            .axisLeft(y)
            .ticks(4)
            .tickSize(-width + margin.left + margin.right);

          svg
            .append("g")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .attr("class", "axis")
            .call(xAxis);

          svg
            .append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .attr("class", "axis")
            .call(yAxis)
            .call((g) =>
              g.selectAll(".tick line").attr("stroke-dasharray", "2,2")
            )
            .call((g) => g.select(".domain").remove());

          const line = d3
            .line()
            .x((d) => x(d.month))
            .y((d) => y(d.count))
            .curve(d3.curveMonotoneX);

          svg
            .selectAll(".skill-line")
            .data(ranked)
            .join("g")
            .attr("class", "skill-line")
            .append("path")
            .attr("fill", "none")
            .attr("stroke-width", 2)
            .attr("stroke", (d) => color(d.skill))
            .attr("d", (d) => line(d.values))
            .attr("opacity", 0.9);

          ranked.forEach((s) => {
            const cls = s.skill.replace(/\s+/g, "-");
            svg
              .selectAll(`.point-${cls}`)
              .data(s.values)
              .join("circle")
              .attr("class", `point-${cls}`)
              .attr("cx", (d) => x(d.month))
              .attr("cy", (d) => y(d.count))
              .attr("r", 3)
              .attr("fill", color(s.skill))
              .on("mouseenter", (event, dVal) => {
                tooltip
                  .style("opacity", 1)
                  .style("left", event.offsetX + 14 + "px")
                  .style("top", event.offsetY - 8 + "px")
                  .html(
                    `<strong>${s.skill}</strong><br>${d3.timeFormat("%B %Y")(
                      dVal.month
                    )}<br>${dVal.count} offer(s)`
                  );
              })
              .on("mouseleave", () => {
                tooltip.style("opacity", 0);
              });
          });

          const legendItems = legendDiv
            .selectAll(".legend-item")
            .data(ranked)
            .join("div")
            .attr("class", "legend-item");

          legendItems
            .append("div")
            .attr("class", "legend-swatch")
            .style("background", (d) => color(d.skill));

          legendItems
            .append("span")
            .text((d) => `${d.skill} · ${d.total} mention(s)`);
        }

        /* 9. GENERIC DRIFT CHART (soft skills & domains) */
        function genericDriftChart({
          idPrefix,
          accessor,
          titleAccessor,
          minCount,
          maxSeries,
        }) {
          const container = document.getElementById(`${idPrefix}-container`);
          const svg = d3.select(`#${idPrefix}-svg`);
          const tooltip = d3.select(`#${idPrefix}-tooltip`);
          const legendDiv = d3.select(`#${idPrefix}-legend`);

          if (!container || svg.empty()) return;

          svg.selectAll("*").remove();
          legendDiv.selectAll("*").remove();

          const data = filteredJobs.length ? filteredJobs : allJobs;
          if (!data.length) return;

          const width = container.clientWidth || 600;
          const height = container.clientHeight || 260;
          const margin = { top: 20, right: 10, bottom: 26, left: 50 };

          svg.attr("viewBox", [0, 0, width, height]);

          const monthSet = new Set();
          data.forEach((d) => {
            if (d._month) monthSet.add(+d._month);
          });
          const months = Array.from(monthSet)
            .map((t) => new Date(t))
            .sort(d3.ascending);

          if (!months.length) {
            svg
              .append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .attr("fill", "#6b7280")
              .text("No temporal signal in the current filters.");
            return;
          }

          const maxMonths = 8;
          const selectedMonths =
            months.length > maxMonths ? months.slice(-maxMonths) : months;

          const records = [];
          data.forEach((d) => {
            if (!d._month) return;
            const monthKey = +d._month;
            if (!selectedMonths.some((m) => +m === monthKey)) return;
            const values = accessor(d) || [];
            const unique = new Set(values);
            unique.forEach((val) => {
              if (val) {
                records.push({
                  month: new Date(monthKey),
                  item: val,
                });
              }
            });
          });

          if (!records.length) {
            svg
              .append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .attr("fill", "#6b7280")
              .text("Not enough signal to show evolution.");
            return;
          }

          const aggregated = d3.rollups(
            records,
            (v) => v.length,
            (d) => d.item,
            (d) => +d.month
          );

          const series = aggregated.map(([item, entries]) => {
            const map = new Map(entries);
            return {
              item,
              values: selectedMonths.map((m) => ({
                month: m,
                count: map.get(+m) || 0,
              })),
            };
          });

          const ranked = series
            .map((s) => ({
              ...s,
              total: d3.sum(s.values, (v) => v.count),
            }))
            .filter((s) => s.total >= minCount)
            .sort((a, b) => b.total - a.total)
            .slice(0, maxSeries);

          if (!ranked.length) {
            svg
              .append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .attr("fill", "#6b7280")
              .text("Not enough signal to show evolution.");
            return;
          }

          const x = d3
            .scaleTime()
            .domain(d3.extent(selectedMonths))
            .range([margin.left, width - margin.right]);

          const maxCount = d3.max(ranked, (s) =>
            d3.max(s.values, (v) => v.count)
          );
          const y = d3
            .scaleLinear()
            .domain([0, maxCount || 1])
            .nice()
            .range([height - margin.bottom, margin.top + 10]);

          const color = d3
            .scaleOrdinal()
            .domain(ranked.map((d) => d.item))
            .range([
              "#22d3ee",
              "#a855f7",
              "#f97316",
              "#4ade80",
              "#facc15",
              "#38bdf8",
            ]);

          const xAxis = d3
            .axisBottom(x)
            .ticks(selectedMonths.length)
            .tickFormat(d3.timeFormat("%b %y"));
          const yAxis = d3
            .axisLeft(y)
            .ticks(4)
            .tickSize(-width + margin.left + margin.right);

          svg
            .append("g")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .attr("class", "axis")
            .call(xAxis);

          svg
            .append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .attr("class", "axis")
            .call(yAxis)
            .call((g) =>
              g.selectAll(".tick line").attr("stroke-dasharray", "2,2")
            )
            .call((g) => g.select(".domain").remove());

          const line = d3
            .line()
            .x((d) => x(d.month))
            .y((d) => y(d.count))
            .curve(d3.curveMonotoneX);

          svg
            .selectAll(".item-line")
            .data(ranked)
            .join("g")
            .attr("class", "item-line")
            .append("path")
            .attr("fill", "none")
            .attr("stroke-width", 2)
            .attr("stroke", (d) => color(d.item))
            .attr("d", (d) => line(d.values))
            .attr("opacity", 0.9);

          ranked.forEach((s) => {
            const cls = s.item.replace(/\s+/g, "-");
            svg
              .selectAll(`.point-${cls}`)
              .data(s.values)
              .join("circle")
              .attr("class", `point-${cls}`)
              .attr("cx", (d) => x(d.month))
              .attr("cy", (d) => y(d.count))
              .attr("r", 3)
              .attr("fill", color(s.item))
              .on("mouseenter", (event, dVal) => {
                tooltip
                  .style("opacity", 1)
                  .style("left", event.offsetX + 14 + "px")
                  .style("top", event.offsetY - 8 + "px")
                  .html(
                    `<strong>${titleAccessor(
                      s.item
                    )}</strong><br>${d3.timeFormat("%B %Y")(dVal.month)}<br>${
                      dVal.count
                    } offer(s)`
                  );
              })
              .on("mouseleave", () => {
                tooltip.style("opacity", 0);
              });
          });

          const legendItems = legendDiv
            .selectAll(".legend-item")
            .data(ranked)
            .join("div")
            .attr("class", "legend-item");

          legendItems
            .append("div")
            .attr("class", "legend-swatch")
            .style("background", (d) => color(d.item));

          legendItems
            .append("span")
            .text((d) => `${titleAccessor(d.item)} · ${d.total} mention(s)`);
        }

        function updateSoftSkillDriftChart() {
          genericDriftChart({
            idPrefix: "soft-drift",
            accessor: (d) => d._softSkills,
            titleAccessor: (s) => s,
            minCount: 3,
            maxSeries: 6,
          });
        }

        /* 10. MY MARKET WORTH */
        let mmwSelectedSkills = new Set();

        function initMyMarketWorthModule() {
          const chipsContainer = document.getElementById("mmw-skill-chips");
          const expSelect = document.getElementById("mmw-experience");

          if (!chipsContainer) return;
          chipsContainer.innerHTML = "";
          mmwSelectedSkills.clear();

          MMW_SKILLS.forEach((skill) => {
            const div = document.createElement("div");
            div.className = "chip";
            div.textContent = skill;
            div.dataset.skill = skill;
            div.addEventListener("click", () => {
              if (mmwSelectedSkills.has(skill)) {
                mmwSelectedSkills.delete(skill);
                div.classList.remove("active");
              } else {
                mmwSelectedSkills.add(skill);
                div.classList.add("active");
              }
              updateMyMarketWorthChart();
            });
            chipsContainer.appendChild(div);
          });

          if (expSelect) {
            expSelect.addEventListener("change", () => {
              updateMyMarketWorthChart();
            });
          }
        }

        function updateMyMarketWorthChart() {
          const svg = d3.select("#mmw-svg");
          const tooltip = d3.select("#mmw-tooltip");
          const container = document.getElementById("mmw-container");
          const expSelect = document.getElementById("mmw-experience");
          const output = document.getElementById("mmw-output");
          const extra = document.getElementById("mmw-extra");

          svg.selectAll("*").remove();
          if (extra) extra.textContent = "";

          const data = filteredJobs.length ? filteredJobs : allJobs;
          if (!data.length || !output) return;

          const selectedSkills = Array.from(mmwSelectedSkills);
          const expLevel = expSelect ? +expSelect.value : 0;

          if (!selectedSkills.length) {
            output.innerHTML =
              "Select some skills to see your estimated worth inside this dataset.";
            return;
          }

          const scored = data.map((d) => {
            const jobSkills = new Set([...d._techSkills, ...d._toolsUsed]);
            let matchCount = 0;
            selectedSkills.forEach((s) => {
              if (Array.from(jobSkills).some((js) => js.includes(s))) {
                matchCount++;
              }
            });
            const skillScore = matchCount / selectedSkills.length;

            let expScore = 1;
            if (!isNaN(d._exp)) {
              if (expLevel === 0 && d._exp <= 1) expScore = 1.1;
              else if (expLevel === 2 && d._exp >= 2 && d._exp <= 4)
                expScore = 1.1;
              else if (expLevel === 5 && d._exp >= 5) expScore = 1.1;
              else expScore = 0.8;
            }

            return {
              job: d,
              score: skillScore * expScore,
            };
          });

          const filtered = scored.filter((s) => s.score > 0.3);
          const totalOffers = data.length;
          const matchingOffers = filtered.length;

          if (!matchingOffers) {
            output.innerHTML =
              "We couldn't find offers close enough to your stack in the current filters.";
            return;
          }

          const perc = (matchingOffers / totalOffers) * 100;
          const salaries = filtered
            .map((d) => d.job._salary)
            .filter((s) => s && isFinite(s));
          const medianSalary = salaries.length ? d3.median(salaries) : NaN;

          output.innerHTML =
            `Based on the current filters, <span>${matchingOffers.toLocaleString()}</span>` +
            ` offers match your skill stack (${perc.toFixed(
              1
            )}% of all filtered offers).<br>` +
            (medianSalary
              ? `Estimated median salary for similar profiles: <span>$${Math.round(
                  medianSalary
                ).toLocaleString()}</span>.`
              : "No reliable salary information for these offers yet.");

          if (!salaries.length || salaries.length < 5 || !container) return;

          const width = container.clientWidth || 600;
          const height = container.clientHeight || 260;
          const margin = { top: 16, right: 16, bottom: 26, left: 50 };

          svg.attr("viewBox", [0, 0, width, height]);

          const x = d3
            .scaleLinear()
            .domain(d3.extent(salaries))
            .nice()
            .range([margin.left, width - margin.right]);

          const bins = d3.bin().domain(x.domain()).thresholds(10)(salaries);

          const y = d3
            .scaleLinear()
            .domain([0, d3.max(bins, (d) => d.length) || 1])
            .nice()
            .range([height - margin.bottom, margin.top]);

          const xAxis = d3
            .axisBottom(x)
            .ticks(5)
            .tickFormat((d) =>
              d >= 1000 ? "$" + Math.round(d / 1000) + "k" : "$" + Math.round(d)
            );
          const yAxis = d3.axisLeft(y).ticks(4);

          svg
            .append("g")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .attr("class", "axis")
            .call(xAxis);

          svg
            .append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .attr("class", "axis")
            .call(yAxis)
            .call((g) => g.select(".domain").remove());

          const bar = svg
            .selectAll(".bar")
            .data(bins)
            .join("g")
            .attr("class", "bar");

          bar
            .append("rect")
            .attr("x", (d) => x(d.x0) + 1)
            .attr("y", (d) => y(d.length))
            .attr("width", (d) => Math.max(0, x(d.x1) - x(d.x0) - 1))
            .attr("height", (d) => y(0) - y(d.length))
            .attr("fill", "rgba(34,211,238,0.6)")
            .on("mouseenter", (event, d) => {
              tooltip
                .style("opacity", 1)
                .style("left", event.offsetX + 10 + "px")
                .style("top", event.offsetY - 8 + "px")
                .html(
                  `<strong>${d.length} offer(s)</strong><br>` +
                    `Salary range: $${Math.round(
                      d.x0
                    ).toLocaleString()}–$${Math.round(d.x1).toLocaleString()}`
                );
            })
            .on("mouseleave", () => {
              tooltip.style("opacity", 0);
            });

          if (medianSalary) {
            svg
              .append("line")
              .attr("x1", x(medianSalary))
              .attr("x2", x(medianSalary))
              .attr("y1", margin.top)
              .attr("y2", height - margin.bottom)
              .attr("stroke", "#f97316")
              .attr("stroke-dasharray", "4,2")
              .attr("stroke-width", 1.5);

            svg
              .append("text")
              .attr("x", x(medianSalary))
              .attr("y", margin.top - 4)
              .attr("text-anchor", "middle")
              .attr("fill", "#f97316")
              .attr("font-size", 10)
              .text("Median");
          }

          svg
            .append("text")
            .attr("x", width / 2)
            .attr("y", height - 4)
            .attr("text-anchor", "middle")
            .attr("fill", "#6b7280")
            .attr("font-size", 10)
            .text("Salary distribution for offers similar to your profile");

          if (extra) {
            extra.textContent =
              "This is an approximate, dataset-based view — not a salary promise. The more complete your dataset, the more reliable this estimate becomes.";
          }
        }

        /* 11. WORLD MAP */
        function updateWorldMapChart() {
          const container = document.getElementById("worldmap-container");
          const svg = d3.select("#worldmap-svg");
          const tooltip = d3.select("#worldmap-tooltip");
          if (!container || svg.empty()) return;

          svg.selectAll("*").remove();
          if (!tooltip.empty()) tooltip.style("opacity", 0);

          const data = filteredJobs.length ? filteredJobs : allJobs;
          if (!data.length) return;

          const width = container.clientWidth || 600;
          const height = container.clientHeight || 260;
          const margin = { top: 10, right: 10, bottom: 10, left: 10 };

          svg.attr("viewBox", [0, 0, width, height]);

          const countryCounts = d3.rollups(
            data,
            (v) => v.length,
            (d) => (d._country || "Not specified").trim()
          );
          const countMap = new Map(countryCounts);

          function ensureWorldGeo(callback) {
            if (worldGeo) {
              callback();
              return;
            }
            if (!worldGeoPromise) {
              worldGeoPromise = d3
                .json("https://unpkg.com/world-atlas@2/countries-110m.json")
                .then((raw) => {
                  worldGeo = topojson.feature(raw, raw.objects.countries);
                })
                .catch((err) => console.error("World map load error:", err));
            }
            worldGeoPromise.then(callback);
          }

          ensureWorldGeo(() => {
            if (!worldGeo) return;

            const projection = d3
              .geoNaturalEarth1()
              .fitSize(
                [
                  width - margin.left - margin.right,
                  height - margin.top - margin.bottom,
                ],
                worldGeo
              );
            const path = d3.geoPath(projection);

            svg
              .append("g")
              .selectAll("path")
              .data(worldGeo.features)
              .join("path")
              .attr("d", path)
              .attr("fill", "#020617")
              .attr("stroke", "#1f2937")
              .attr("stroke-width", 0.6);

            const points = worldGeo.features
              .map((f) => {
                const name = f.properties.name;
                const count = countMap.get(name) || 0;
                if (!count) return null;
                const centroid = path.centroid(f);
                return { name, count, x: centroid[0], y: centroid[1] };
              })
              .filter(Boolean);

            if (!points.length) {
              svg
                .append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "#6b7280")
                .text("No country-level information in the current filters.");
              return;
            }

            const maxCount = d3.max(points, (d) => d.count) || 1;
            const r = d3.scaleSqrt().domain([1, maxCount]).range([3, 22]);

            svg
              .append("g")
              .selectAll("circle")
              .data(points)
              .join("circle")
              .attr("cx", (d) => d.x)
              .attr("cy", (d) => d.y)
              .attr("r", (d) => r(d.count))
              .attr("fill", "rgba(34,211,238,0.7)")
              .attr("stroke", "#0f172a")
              .attr("stroke-width", 1)
              .on("mouseenter", (event, d) => {
                tooltip
                  .style("opacity", 1)
                  .style("left", event.offsetX + 10 + "px")
                  .style("top", event.offsetY - 8 + "px")
                  .html(
                    `<strong>${
                      d.name
                    }</strong><br>${d.count.toLocaleString()} offer(s)`
                  );
              })
              .on("mouseleave", () => {
                tooltip.style("opacity", 0);
              });
          });
        }

        /* 12. CHART MODAL */
        function setupChartModal() {
          const cards = document.querySelectorAll(".chart-card");
          cards.forEach((card) => {
            card.addEventListener("click", (event) => {
              if (event.target.tagName.toLowerCase() === "select") return;

              const title = card.querySelector("h3")?.textContent || "";
              const svg = card.querySelector("svg");
              const subtitle =
                card.querySelector(".chart-subtitle")?.textContent || "";

              if (!svg || !modalBackdrop || !modalContainer) return;

              modalContainer.innerHTML = "";
              const cloned = svg.cloneNode(true);
              modalContainer.appendChild(cloned);

              if (modalTitle) modalTitle.textContent = title;
              if (modalDescription) modalDescription.textContent = subtitle;

              modalBackdrop.classList.remove("hidden");
            });
          });

          if (modalCloseBtn) {
            modalCloseBtn.addEventListener("click", hideModal);
          }
          if (modalBackdrop) {
            modalBackdrop.addEventListener("click", (e) => {
              if (e.target === modalBackdrop) hideModal();
            });
          }
          document.addEventListener("keydown", (e) => {
            if (
              e.key === "Escape" &&
              modalBackdrop &&
              !modalBackdrop.classList.contains("hidden")
            ) {
              hideModal();
            }
          });
        }

        function hideModal() {
          if (!modalBackdrop || !modalContainer || !modalDescription) return;
          modalBackdrop.classList.add("hidden");
          modalContainer.innerHTML = "";
          modalDescription.textContent = "";
        }
      });
    </script>
  </body>
</html>
